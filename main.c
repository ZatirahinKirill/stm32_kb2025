#include <stdint.h>
#include <stm32f10x.h>
#include <stdbool.h>

#define LCD_W 128
#define LCD_H 8
#define FONT_W 11
#define FONT_H 3

uint8_t FONT_HIGH_TIMER[FONT_H][FONT_W*10] = {// 'image_my3', 110x24px
0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 
0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 
0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 
0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xc0, 
0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0xff, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x06, 0x03, 0xff, 
0xff, 0x00, 0x00, 0x00, 0x00, 0xe1, 0xe0, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3f, 0x3f, 0x00, 0x00, 
0x01, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0xef, 0x00, 0x00, 0x3f, 0x3f, 0x20, 0x20, 0x20, 
0x20, 0x20, 0xff, 0xff, 0x00, 0x00, 0x3f, 0x3f, 0x20, 0x20, 0x20, 0x20, 0x20, 0xe0, 0xc1, 0x00, 
0x00, 0xff, 0xff, 0x20, 0x20, 0x20, 0x20, 0x60, 0xe0, 0xc1, 0x00, 0x00, 0x01, 0x00, 0x00, 0xc0, 
0xf0, 0x38, 0x0e, 0x07, 0x03, 0x00, 0x00, 0xff, 0x70, 0x20, 0x20, 0x20, 0x20, 0x70, 0xff, 0xff, 
0x00, 0x00, 0x3f, 0x30, 0x20, 0x20, 0x20, 0x20, 0x70, 0xff, 0xff, 0x00, 0x00, 0x1f, 0x18, 0x10, 
0x10, 0x10, 0x10, 0x18, 0x1f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x1f, 0x1f, 0x10, 
0x00, 0x00, 0x00, 0x1f, 0x1f, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x18, 0x00, 0x00, 0x1c, 0x18, 
0x10, 0x10, 0x10, 0x10, 0x10, 0x18, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x1f, 0x1f, 0x00, 0x00, 0x18, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x1f, 0x1f, 0x00, 0x00, 0x1f, 
0x1f, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x10, 0x1f, 0x1f, 0x10, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x1f, 0x1f, 0x00, 0x00, 
0x1c, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x1f, 0x0f, 0x00};

uint8_t FONT_LOW_TIMER[FONT_H][FONT_W*10] = {// 'image_my4', 110x24px
0x00, 0xf8, 0x18, 0x08, 0x08, 0x08, 0x08, 0x18, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 
0x60, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x38, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0xf8, 0xf8, 
0x00, 0x00, 0x38, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x18, 0xf8, 0x00, 0x00, 0xf8, 0xf8, 0x00, 
0x00, 0x00, 0x00, 0x00, 0xf8, 0xf8, 0x00, 0x00, 0xf8, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x18, 
0x38, 0x00, 0x00, 0xf8, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x18, 0x38, 0x00, 0x00, 0x38, 0x18, 
0x08, 0x08, 0x08, 0x08, 0xc8, 0xf8, 0x78, 0x00, 0x00, 0xf8, 0x18, 0x08, 0x08, 0x08, 0x08, 0x18, 
0xf8, 0xf8, 0x00, 0x00, 0xf8, 0x18, 0x08, 0x08, 0x08, 0x08, 0x18, 0xf8, 0xf8, 0x00, 0x00, 0xff, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xff, 
0xff, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0x04, 0x04, 0x04, 0x04, 0x04, 0x07, 0x07, 0x00, 0x00, 
0x80, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x0f, 0xfd, 0x00, 0x00, 0x07, 0x07, 0x04, 0x04, 0x04, 
0x04, 0x04, 0xff, 0xff, 0x00, 0x00, 0x07, 0x07, 0x04, 0x04, 0x04, 0x04, 0x04, 0xfc, 0xf8, 0x00, 
0x00, 0xff, 0xff, 0x04, 0x04, 0x04, 0x04, 0x0c, 0x1c, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 
0xfe, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0xff, 0x0e, 0x04, 0x04, 0x04, 0x04, 0x0e, 0xff, 0xff, 
0x00, 0x00, 0x87, 0x06, 0x04, 0x04, 0x04, 0x04, 0x0e, 0xff, 0xff, 0x00, 0x00, 0x03, 0x03, 0x02, 
0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x03, 0x03, 0x02, 
0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x00, 0x00, 0x03, 0x03, 
0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x03, 0x03, 0x00, 0x00, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x00, 0x00, 0x03, 
0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x03, 0x02, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x00, 0x00, 
0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x01, 0x00};


uint8_t LCD_buf[LCD_H][LCD_W]={// 'image', 128x64px
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0x00, 
0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 
0x40, 0x40, 0x40, 0xc0, 0xc0, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xc0, 0xc0, 0xc0, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe1, 0xe0, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3f, 0x3f, 0x00, 
0x00, 0xff, 0xff, 0x20, 0x20, 0x20, 0x20, 0x60, 0xe0, 0xe1, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 
0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x06, 
0x03, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe1, 0xe0, 0x20, 0x20, 
0x20, 0x20, 0x20, 0x3f, 0x3f, 0x00, 0x00, 0xff, 0xff, 0x20, 0x20, 0x20, 0x20, 0x60, 0xe0, 0xe1, 
0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x0c, 0x06, 0x03, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x1f, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x18, 0x00, 
0x00, 0x1f, 0x1f, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 
0x1f, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x1f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 
0x10, 0x1f, 0x1f, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x1f, 0x18, 0x10, 
0x10, 0x10, 0x10, 0x18, 0x18, 0x00, 0x00, 0x1f, 0x1f, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 
0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x1f, 0x18, 0x10, 0x10, 0x10, 0x10, 0x18, 0x1f, 0x1f, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x1f, 0x1f, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
0x94, 0x94, 0x94, 0x94, 0xf4, 0xf4, 0x04, 0xf4, 0xf4, 0x94, 0x94, 0xf4, 0xf4, 0x04, 0xc4, 0xc4, 
0x04, 0xf4, 0xf4, 0x14, 0x14, 0xf4, 0xf4, 0x04, 0xf4, 0xf4, 0x94, 0x94, 0x94, 0x94, 0x04, 0x04, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
0x29, 0x29, 0x29, 0x29, 0x2f, 0x2f, 0x20, 0x2f, 0x2f, 0x29, 0x29, 0x2f, 0x2f, 0x20, 0x26, 0x26, 
0x20, 0x2f, 0x2f, 0x28, 0x28, 0x2f, 0x2f, 0x20, 0x2f, 0x2f, 0x29, 0x29, 0x2f, 0x2f, 0x20, 0x20, 
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0xf8, 0xf8, 
0x00, 0x00, 0xf8, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x18, 0x38, 0x00, 0x00, 0x80, 0x80, 0x00, 
0x00, 0xf8, 0x18, 0x08, 0x08, 0x08, 0x08, 0x18, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
0xc0, 0x60, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x18, 0x08, 0x08, 
0x08, 0x08, 0x08, 0xf8, 0xf8, 0x00, 0x00, 0xf8, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x18, 0x38, 
0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0xf8, 0x18, 0x08, 0x08, 0x08, 0x08, 0x18, 0xf8, 0xf8, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0x60, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0x04, 0x04, 0x04, 0x04, 0x04, 0x07, 0x07, 
0x00, 0x00, 0xff, 0xff, 0x04, 0x04, 0x04, 0x04, 0x0c, 0x1c, 0xfc, 0x00, 0x00, 0x61, 0x61, 0x00, 
0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0x04, 0x04, 
0x04, 0x04, 0x04, 0x07, 0x07, 0x00, 0x00, 0xff, 0xff, 0x04, 0x04, 0x04, 0x04, 0x0c, 0x1c, 0xfc, 
0x00, 0x00, 0x61, 0x61, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 
0x00, 0x00, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x02, 0x02, 0x03, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x02, 
0x02, 0x02, 0x02, 0x03, 0x03, 0x00, 0x00, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x03, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
int blink_on = 1;

//задержка в миллисекундах
void delay_us(uint32_t us){
    __asm volatile (
        //задержка в миллисекундах (ASM)
        //push{r0}
        //mov R0, %val     //val = (9 * us) for 72Mhz
        //_loop:           //approx. 8ticks/iteration
        //    cmp R0, #0    //1
        //    beq_exit      //1 or 1+P (when condition is True)
        //    sub R0,R0,#1  //1
        //    nop           //1 allignment
        //    b _loop       //1+P (pipeline refill) ~4 cycle
        //_exit:
        //    pop{r0}
        
        "push {r0}\r\n"
        "mov R0, %0\r\n"
        "_loop:\r\n"
            "cmp R0, #0\r\n"
            "beq _exit\r\n"
            "sub R0, R0, #1\r\n"
            "nop\r\n" 
            "b _loop\r\n"
        "_exit:\r\n"
            "pop {r0}\r\n"
        :: "r"(9*us) // for 72 Mhz
    );
}

/* Interrupt handler */
void TIM2_IRQHandler(void) {
    if (TIM2->SR & TIM_SR_UIF) {
        if(GPIOC->ODR & GPIO_ODR_ODR13){
            GPIOC->ODR &= ~GPIO_ODR_ODR13;
        } else {
            GPIOC->ODR |= GPIO_ODR_ODR13;
        }
    //Clear Interrupt flag
    TIM2->SR &= ~TIM_SR_UIF;
    }
}
/*
//EXTI0 interrupt handler 
void EXTI0_IRQHandler(){
    if (EXTI->PR & EXTI_PR_PR0) {
        if(GPIOC->ODR & GPIO_ODR_ODR13){
            GPIOC->ODR &= ~GPIO_ODR_ODR13;
        } else {
            GPIOC->ODR |= GPIO_ODR_ODR13;
        }
    //Clear Interrupt flag
    EXTI->PR = EXTI_PR_PR0; //сброс прерывания
    delay_us(50);
    }
}
*/
//EXTI0 interrupt handler 
void EXTI0_IRQHandler(){
    EXTI->PR = EXTI_PR_PR0; //сброс прерывания
        if(blink_on == 1){
            TIM2->CR1 &= ~TIM_CR1_CEN; // Stop timer
            blink_on = 0;
        } else {
            TIM2->CR1 |= TIM_CR1_CEN; // Start timer
            blink_on = 1;
        }
    delay_us(100);
}

//=============_Display_=========================================================
//отправка данных
void SPI1_Write(uint8_t data){
    while (!(SPI1->SR & SPI_SR_TXE)); //ждем пока не освободится буфер передатчика
    SPI1->DR = data; //заполняем буфер передатчика
}
//прием данных
uint8_t SPI1_Read(void){
    SPI1->DR = 0; //очищаем от старых данных
    //ждем пока не появится новое значение в буфере приемника
    while (!(SPI1->SR & SPI_SR_RXNE)); //прерывание по событию RXNE: RXNEIE
    return SPI1->DR;
}

//процедура отправки данных в дисплей
void cmd(uint8_t data){ //отправка команды
    GPIOA->ODR &= ~GPIO_ODR_ODR12; //RS=0 указание на то, что отправляем команду
    GPIOA->ODR &= ~GPIO_ODR_ODR4; //CS=0 указание дисплею, что данные адресованы ему
    delay_us(1000);
    SPI1_Write(data);
    GPIOA->ODR |= GPIO_ODR_ODR4; //CS=1 окончание передачи данных
}

void dat(uint8_t data){ //отправка данных
    GPIOA->ODR |= GPIO_ODR_ODR12; //RS=1 указание на то, что отправляем данные
    GPIOA->ODR &= ~GPIO_ODR_ODR4; //CS=0 указание дисплею, что данные адресованы ему
    delay_us(1000);
    SPI1_Write(data);
    GPIOA->ODR |= GPIO_ODR_ODR4; //CS = 1 окончание передачи данных
}

void load_buff(){
    for(int i=0;i<8;i++){
        cmd(0b10110000|i); //page = i
        cmd(0b00010000); //column = 0
        cmd(0b00000000);
        for(int j=0;j<128;j++){
            dat(LCD_buf[i][j]);
        }
    }
}

void update_digit(int p, int y, int digit){
    if (p==0){
        for(int i = 0; i < FONT_W; i++)
        {
            LCD_buf[p][y + i] = FONT_HIGH_TIMER[0][FONT_W * digit + i]; //page 1
            LCD_buf[p + 1][y + i] = FONT_HIGH_TIMER[1][FONT_W* digit + i]; //page 2
            LCD_buf[p + 2][y + i] = FONT_HIGH_TIMER[2][FONT_W* digit + i]; //page 3
        }
    }
    if (p==5){
        for(int i = 0; i < FONT_W; i++)
        {
            LCD_buf[p][y + i] = FONT_LOW_TIMER[0][FONT_W * digit + i]; //page 1
            LCD_buf[p + 1][y + i] = FONT_LOW_TIMER[1][FONT_W* digit + i]; //page 2
            LCD_buf[p + 2][y + i] = FONT_LOW_TIMER[2][FONT_W* digit + i]; //page 3
        }
    }
}

void update_timer(int timer, int hours, int minutes){
    int timers[4][2] = {{0,5},{0,75},{5,5},{5,75}};
    int x = timers[timer-1][0];
    int y = timers[timer-1][1];
    update_digit(x,y, hours/10);
    update_digit(x,y + FONT_W, hours%10);
    y = y + 26;
    update_digit(x,y, minutes/10);
    update_digit(x,y + FONT_W, minutes%10);

}
//===============================================================

int main(void) {
    // int i = 0;
    // int mask = 8; // 8 = 0b10000 = 0x8 = (1 << 4)
    // i = i | mask; // i |= mask;
    
    /* IO PORTS Configuration */
    RCC->APB2ENR |= RCC_APB2ENR_IOPCEN | RCC_APB2ENR_SPI1EN; // 0b10000=0x10
    GPIOC->CRH &= ~(GPIO_CRH_CNF13 | GPIO_CRH_MODE13); // GPIOC->CRH[23:20]=0000
    GPIOC->CRH |= GPIO_CRH_MODE13_0; // GPIOC->CRH[23:20]=0001
    
    //Port PB0 as Input
    //Включаем тактовый сигнал порт B
    RCC->APB2ENR |= RCC_APB2ENR_IOPBEN | RCC_APB2ENR_AFIOEN;
    //Настраиваем режим input
    GPIOB->CRL &= ~(GPIO_CRL_CNF0 | GPIO_CRL_MODE0); // GPIOB->CRL[3:0]=0000
    GPIOB->CRL |= GPIO_CRL_CNF0_1; // GPIOB->CRL[3:0]=1000
    //Настраиваем режим pull-up resister
    GPIOB->ODR |= GPIO_ODR_ODR0; // PB0 Internal pull-up resister
    
    //SPI IO Configuration
    //Включаем тактовый сигнал порт A
    RCC->APB2ENR |= RCC_APB2ENR_IOPAEN;
    //A4
    GPIOA->CRL &= ~(GPIO_CRL_CNF4 | GPIO_CRL_MODE4); // GPIOA->CRL[19:16]=0000
    GPIOA->CRL |= GPIO_CRL_MODE4_0; //GPIOC->CRL[19:16]=0001
    //A11
    GPIOA->CRH &= ~(GPIO_CRH_CNF11 | GPIO_CRH_MODE11); // GPIOA->CRH[15:12]=0000
    GPIOA->CRH |= GPIO_CRH_MODE11_0; //GPIOC->CRH[15:12]=0001
    //A12
    GPIOA->CRH &= ~(GPIO_CRH_CNF12 | GPIO_CRH_MODE12); // GPIOA->CRH[19:16]=0000
    GPIOA->CRH |= GPIO_CRH_MODE12_0; //GPIOC->CRH[19:16]=0001
    //A5
    GPIOA->CRL &= ~(GPIO_CRL_CNF5 | GPIO_CRL_MODE5); // GPIOA->CRL[23:20]=0000
    GPIOA->CRL |= GPIO_CRL_MODE5_0; //GPIOC->CRL[23:20]=0001
    GPIOA->CRL |= GPIO_CRL_CNF5_1;  //GPIOC->CRL[23:20]=1001
    //A7
    GPIOA->CRL &= ~(GPIO_CRL_CNF7 | GPIO_CRL_MODE7); // GPIOA->CRL[31:28]=0000
    GPIOA->CRL |= GPIO_CRL_MODE7_0; //GPIOC->CRL[31:28]=0001
    GPIOA->CRL |= GPIO_CRL_CNF7_1;  //GPIOC->CRL[31:28]=1001
    //SPI IO Configuration
    SPI1->CR1 &= ~SPI_CR1_DFF; //DFF=0 кадр 8 бит
    SPI1->CR1 &= ~SPI_CR1_CRCEN; //CRCEN=0 CRC off
    SPI1->CR1 |= SPI_CR1_SSM; //SSM=1
    SPI1->CR1 |= SPI_CR1_SSI; //SSI=1
    SPI1->CR1 &= ~SPI_CR1_BR; //BR[2:0]=000
    //SPI1->CR1 |= SPI_CR1_BR_2; //BR[2:0]=100
    SPI1->CR1 |= SPI_CR1_MSTR; //MSTR=1
    SPI1->CR1 &= ~SPI_CR1_CPOL; //CPOL=0 полярность
    SPI1->CR1 &= ~SPI_CR1_CPHA; //CPHA=0 фаза
    SPI1->CR1 |= SPI_CR1_SPE; //SPE=1

    //Процедура инициализации дисплея
    GPIOA->ODR &= ~GPIO_ODR_ODR4; //CS=0
    GPIOA->ODR &= ~GPIO_ODR_ODR11; //RESET=0
    delay_us(10000);
    GPIOA->ODR |= GPIO_ODR_ODR11; //RESET=1
    delay_us(1000);
    cmd(0xA2); //LCD Drive set 1/9
    cmd(0xA0); //RAM Address SEG Output normal
    cmd(0xC8); //Common output mode selection
    cmd(0x28|0x07); //Power control mode
    cmd(0x20|0x05); //Voltage regulator
    cmd(0xA6); //Normal color, A7 = inverse color
    cmd(0xAF); //Display on

    //EXTI configuration
    /*AFIO->EXTICR[0] = AFIO_EXTICR1_EXTI0_PB; //EXTI0 = PB0
    EXTI->FTSR = EXTI_FTSR_TR0; //EXTI0 enable falling edge detection
    EXTI->IMR=EXTI_IMR_MR0; //enable interrupt on EXTI0
    NVIC_SetPriority(EXTI0_IRQn,0); // делаем прерывание высокоприоритетным.
    NVIC_EnableIRQ(EXTI0_IRQn); //Enable interrupt EXTI0
    */

    //таймер
    /* TIM2 Configuration */
    /*
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;
    RCC->APB1RSTR |= RCC_APB1RSTR_TIM2RST;
    RCC->APB1RSTR &= ~RCC_APB1RSTR_TIM2RST;
    TIM2->PSC = 4000;
    TIM2->ARR = 18000;
    TIM2->DIER |= TIM_DIER_UIE; // Enable Update Interrupt
    NVIC_ClearPendingIRQ(TIM2_IRQn);
    //EXTI9_5_IRQn
    NVIC_EnableIRQ(TIM2_IRQn); // Enable IRQ in NVIC
    TIM2->CR1 |= TIM_CR1_CEN; // Start timer
    while (1) {
        __asm volatile ("nop");
    }
    */

    /*
    cmd(0xB0);
    cmd(0b00010000);
    cmd(0x00);
    for(int i=0;i<8;i++){
        cmd(0b10110000|i); //page = i
        cmd(0b00010000); //column = 0
        cmd(0b00000000);
        for(int j=0;j<128;j++){
            dat(0);
        }
    }
    while (1){
        if(GPIOB->IDR & GPIO_IDR_IDR0){
            GPIOC->ODR &= ~GPIO_ODR_ODR13;
        } else{
            GPIOC->ODR |= GPIO_ODR_ODR13;
        }
        dat(0xFF);
    }
    */

    //просто мигает
    /*
    while(1){
        GPIOC->ODR &= ~GPIO_ODR_ODR13;
        delay_us(1000000);
        GPIOC->ODR |= GPIO_ODR_ODR13;
        delay_us(1000000);
    }
    */

    //load_buff();
    for (int i = 1; i < 5; i++){
        update_timer(i,0,0);
    }
    update_timer(1,15,32);
    load_buff();

return 0;
}
